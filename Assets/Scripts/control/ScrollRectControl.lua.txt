---------------------------------------------------------------------
local unity=CS.UnityEngine
ScrollRectControl={}
ScrollRectControl.needDispose={}
function init()
	avatarControl=unity.GameObject.Find("AvatarSystem"):GetComponent("AvatarControl")
	package.path=CS.UnityEngine.Application.dataPath.."/Scripts/model/?.lua"
	require("ScrollRectModel")
	ScrollRectControl.ScrollModel=ScrollRectModel
	ScrollRectControl.ScrollModel.setScrollControl(ScrollRectControl)
	ScrollRectControl.scrollRectView=self.gameObject:GetComponent("ScrollRectUIView")
	ScrollRectControl.loadAssets(3,3,80,0,"item")
	ScrollRectControl.setRecord()
end

--config the moduel
function ScrollRectControl.loadAssets(row1,col1,itemWidth1,chink1,prefabName)
	ScrollRectControl.item=unity.Resources.Load(prefabName)
	ScrollRectControl.row=row1
	self.row=row1
	ScrollRectControl.col=col1
	self.col=col1
	ScrollRectControl.chink=chink1
	ScrollRectControl.itemWidth=itemWidth1
	self.itemSize=ScrollRectControl.getItemSize()
	ScrollRectControl.cell=ScrollRectControl.chink+ScrollRectControl.itemWidth
	self.cell=ScrollRectControl.cell
	self.isDragIng=false
	ScrollRectControl.isLoadingRecord=false
	ScrollRectControl.datasAndIndex=self.datasAndIndex
end

--config grid
function setRecordAndGrid()
	while ScrollRectControl.isLoadingRecord do
		coroutine.yield()
	end
	ScrollRectControl.isLoadingRecord=true
	local dat=avatarControl:getAllMeshNameOfPart(ScrollRectControl.scrollRectView.partName)
	local ddd={}
	for i =0,dat.Count-1,1 do
		ddd[i+1]=dat[i]
	end
	
	ScrollRectControl.ScrollModel.setDatas(ddd)
	local count=ScrollRectControl.ScrollModel.getDatasLength()
	self.dataCount=count
	h=count/ScrollRectControl.col*ScrollRectControl.cell
	if count%ScrollRectControl.col~=0 then
		h=h+ScrollRectControl.cell
	end
	ScrollRectControl.scrollRectView:setContent(ScrollRectControl.col*ScrollRectControl.cell,h)
	
	local temCount
	if count>=ScrollRectControl.row*ScrollRectControl.col then
		temCount=ScrollRectControl.row*ScrollRectControl.col
	else
		temCount=count
	end
	for i = 0, temCount-1,1 do
		ScrollRectControl.GnenerNewItem(i)
	end
	ScrollRectControl.isLoadingRecord=false
	
end
function ScrollRectControl.setRecord()
	ScrollRectControl.ScrollModel.clearDatas()
	ScrollRectControl.needDispose={}
	local ots=coroutine.create(setRecordAndGrid)
	coroutine.resume(ots)
end



function ScrollRectControl.getItemSize()
	local size=CS.UnityEngine.Vector2(ScrollRectControl.itemWidth*2,ScrollRectControl.itemWidth*2)
	return size
end

function  ScrollRectControl.GnenerNewItem(index)
	local go=CS.UnityEngine.Object.Instantiate(ScrollRectControl.item,CS.UnityEngine.Vector3(0,0,0),CS.UnityEngine.Quaternion.identity)
	ScrollRectControl.datasAndIndex:Add(go,index)
	local itemName=ScrollRectControl.ScrollModel.getDataByIndex(index)
	local size=ScrollRectControl.getItemSize()
	local pos=ScrollRectControl.getItemPosition(index)
	ScrollRectControl.scrollRectView:setRecordItem(index,go,itemName,size,pos)
end
function SetNewItem(index)
	local go=ScrollRectControl.getItemFromNeedDispose()
	if go~=nil then
		ScrollRectControl.datasAndIndex:Add(go,index)
		local itemName=ScrollRectControl.ScrollModel.getDataByIndex(index)
		if(itemName==nil) then
		end
		local size=ScrollRectControl.getItemSize()
		local pos=ScrollRectControl.getItemPosition(index)
		ScrollRectControl.scrollRectView:setRecordItem(index,go,itemName,size,pos)
	end
	
end

function ScrollRectControl.getItemFromNeedDispose()
	local gos
	if #ScrollRectControl.needDispose>0 then
		gos=ScrollRectControl.needDispose[1]
		table.remove(ScrollRectControl.needDispose,1)
	end
	return  gos
end
function RecycleItem(go)
	table.insert(ScrollRectControl.needDispose,go)
	ScrollRectControl.scrollRectView:disableItem(go)

end

function ScrollRectControl.getItemPosition(index)
	local x=(index%ScrollRectControl.col)*ScrollRectControl.cell+0.5*ScrollRectControl.cell
	local y=getPos_Y(index)
	local vt3=CS.UnityEngine.Vector3(x,y,0)
	return  vt3
end

function getPos_Y(index)
	local sizeY=index//ScrollRectControl.col*ScrollRectControl.cell
	sizeY=0-sizeY
	return sizeY
end

function deleteItem(go)
	local res=ScrollRectControl.ScrollModel.DeleteDate(go.name)
	if res then
		ScrollRectControl.datasAndIndex:Remove(go)
		RecycleItem(go)
	end
end

function  onDestroy()
	ScrollRectControl.ScrollModel.clearDatas();
	for k, v in pairs(ScrollRectControl.needDispose) do
		ScrollRectControl.scrollRectView:destroyItem(v)
	end
	ScrollRectControl.needDispose={}
end
init()
